// Purpose: 
// Examines the items from last L orders at a specified warehouse district
// Output the number of those items that have a stock level below a specified threshold

//For (w_id = 1, d_id = 1), num of items below threshold (20) : 314
//startingOrderID: 15298, numOfLastOrder: 38, N is 15336


// 1. Get the next available order number d_next_o_id for district (w_id, d_id)
// Input: w_id = 1, d_id = 1, T = 20, L = 38, N = 15,336
// Output: 15,336 (Checked)

select d_next_o_id 
from team3.district 
where d_w_id = 1 and d_id = 1;

// 2. Get the set of items from last L orders for district (w_id, d_id)
// Input: startingOrderID: 15298, numOfLastOrder: 38, N is 15336
// Output: 15,565, 89,303, 81,479, 86051, ...... 11,841 (Checked)

SELECT ol_o_id, ol_i_id, ol_w_id, ol_d_id 
FROM team3.orderline
WHERE ol_w_id = 1
AND ol_d_id = 1
AND ol_o_id >= 15298 and ol_o_id < 15336;

// 3. Output total number of items in S where its stock quantity at w_id is below the threshold
// s.quantity < T
// Input: T = 15, s_w_id = 1, s_i_id = {retrieved ol_i_id from Step 2}
// Output: 314

select s_quantity 
from team3.stock 
where s_w_id = 1 
and s_i_id 
IN (15565, 89303, 81479, 86051, 15459, 35942, 52451, 23649, 44515, 56039, 89814, 87782, 40314, 93911, 65251, 56981, 15567, 71257, 15814, 93903, 37843, 57055, 95842, 67207, 46686, 78951, 23127, 32419, 94912, 60775, 54951, 38629, 68311, 48867, 79575, 54758, 46538, 78691, 77385, 97637, 30419, 34533, 52891, 65238, 81575, 13877, 48871, 63071, 32282, 69222, 69351, 45927, 79079, 1859, 6149, 40167, 13923, 61157, 15815, 56547, 5551, 98018, 80609, 20156, 40674, 23011, 16467, 24290, 76113, 81589, 73285, 20099, 68447, 51863, 73407, 71399, 71398, 13909, 70359, 40656, 29350, 80975, 23767, 6167, 71383, 5543, 73446, 56215, 3651, 81511, 7994, 65255, 21893, 40159, 53719, 32967, 89811, 48849, 15987, 62151, 42274, 48026, 22239, 96934, 40087, 6214, 54935, 97669, 97639, 19879, 31974, 80548, 92389, 57055, 80999, 18135, 97881, 55003, 81107, 38615, 5182, 54950, 40679, 37445, 13747, 97503, 94247, 72423, 7719, 4135, 64695, 4727, 32423, 32219, 22671, 80338, 72295, 23271, 16098, 74459, 28062, 46662, 53686, 53639, 13973, 81127, 24222, 78882, 98005, 3879, 89671, 6469, 69351, 98023, 40294, 3903, 97990, 45239, 93598, 32375, 9447, 48287, 40549, 72551, 30425, 91868, 29137, 38087, 89818, 40039, 40151, 70368, 57060, 1735, 97895, 24270, 15957, 63189, 65223, 23719, 23207, 40656, 96985, 4162, 9958, 50335, 82885, 77502, 73158, 23446, 13779, 81254, 57061, 81638, 22431, 35551, 16095, 11303, 90837, 73447, 27303, 48263, 68839, 73441, 40159, 88247, 67231, 40662, 64966, 60909, 55751, 32335, 54882, 5919, 44767, 32487, 6147, 40166, 11591, 37220, 46055, 4923, 12967, 15574, 51935, 94435, 44119, 7196, 52455, 56955, 71143, 25314, 81639, 40663, 21199, 86719, 5893, 23910, 48871, 35549, 81383, 89159, 48852, 53987, 76995, 46307, 22947, 95967, 52695, 97965, 93783, 56567, 39867, 11470, 97889, 16789, 11814, 44263, 46759, 57015, 89484, 32400, 65247, 97758, 30429, 69314, 89383, 15901, 56423, 48098, 73447, 63197, 50919, 37900, 81623, 32487, 80103, 88807, 52967, 73159, 22119, 89831, 71717, 27307, 78541, 35942, 3518, 79591, 28127, 28251, 99047, 24279, 1825, 18021, 5959, 95847, 23137, 16063, 23111, 47810, 13767, 26773, 76966, 29337, 89301, 65028, 56804, 64989, 89767, 89809, 81618, 46787, 14049, 71879, 55839, 30183, 40167, 81383, 16103, 46567, 39515, 88791, 54883, 40601, 73183, 5671, 22145, 13926, 64166, 15591, 7743, 72262, 77877, 23125, 44133, 40645, 48349, 14023, 89671, 21966, 64735, 91874, 97638, 29808, 4287, 42470, 24295, 57046, 84967, 13991, 26583, 5187, 91783, 14803, 73350, 69317, 48358, 32485, 89167, 31715, 13983, 31975, 73447, 64703, 39559, 17983, 6215, 15938, 89575, 97783, 11974, 55501, 3399, 89831, 30433, 34229, 88803, 57038, 11845, 81607, 74983, 88094, 6182, 15591, 84783, 91866, 30421, 64743, 52955, 80577, 64983, 21479, 46575, 75959, 44727, 21886, 61591, 81495, 16087, 87763, 37751, 97745, 46822, 39629, 16101, 32487, 72415, 62183, 48867, 76421, 73421, 64927, 47271, 81446, 98011, 44582, 71034, 14989, 2071, 63775, 54998, 18911, 95063, 80956, 5826, 5443, 86247, 68451, 40503, 81542, 69187, 75363, 23271, 87746, 68756, 62694, 15437, 31461, 7415, 30116, 56820, 73383, 50788, 89511, 27619, 61077, 24266, 56999, 14535, 32262, 22100, 11841) 
and s_quantity < 20 ALLOW FILTERING;